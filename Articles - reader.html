<!DOCTYPE html>
<html lang="tl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <!-- Article Header -->
  <header class="relative">
    <img id="mainImage" src="" alt="Main" class="w-full h-64 object-cover">
    <div class="absolute top-4 left-4 flex items-center bg-black bg-opacity-50 text-white p-2 rounded">
      <img id="authorImage" src="" alt="Author" class="w-10 h-10 rounded-full mr-2">
      <span id="authorName" class="font-semibold">Author Name</span>
    </div>
  </header>

  <!-- Article Content -->
  <main class="max-w-3xl mx-auto p-4">
    <h1 id="title" class="text-3xl font-bold mb-4"></h1>
    <div id="body" class="prose dark:prose-invert"></div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between mt-8">
      <button id="prevBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600" style="display:none">Previous</button>
      <button id="nextBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600" style="display:none">Next</button>
    </div>

    <!-- Comments Section -->
    <section class="mt-12">
      <h2 class="text-2xl font-semibold mb-4">Comments</h2>
      <div id="authSection" class="mb-4">
        <button id="googleSignInBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Sign in with Google to comment</button>
        <span id="userInfo" class="ml-4 hidden">Logged in as <span id="userName"></span> <button id="signOutBtn" class="ml-2 px-2 py-1 bg-red-500 rounded text-white">Sign Out</button></span>
      </div>
      <div id="commentForm" class="mb-4 hidden">
        <textarea id="commentInput" rows="3" class="w-full p-2 border rounded mb-2" placeholder="Write a comment..."></textarea>
        <button id="submitComment" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Submit</button>
      </div>
      <div id="commentsList" class="space-y-4"></div>
    </section>
  </main>

  <script>
    // ========== Firebase Config ==========
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ========== Variables ==========
    const titleEl = document.getElementById('title');
    const bodyEl = document.getElementById('body');
    const mainImage = document.getElementById('mainImage');
    const authorImage = document.getElementById('authorImage');
    const authorName = document.getElementById('authorName');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const userInfo = document.getElementById('userInfo');
    const userNameEl = document.getElementById('userName');
    const signOutBtn = document.getElementById('signOutBtn');
    const commentForm = document.getElementById('commentForm');
    const commentInput = document.getElementById('commentInput');
    const submitComment = document.getElementById('submitComment');
    const commentsList = document.getElementById('commentsList');

    // Example article list (should come from list.json or folder manifest)
    const articles = [
      'article1.md',
      'article2.md',
      'article3.md'
    ];

    let currentIndex = 0; // current article index

    function loadArticle(index){
      currentIndex = index;
      const articleFile = articles[index];
      fetch(articleFile)
        .then(res => res.text())
        .then(mdText => {
          // parse front matter (simple regex)
          const fmMatch = mdText.match(/---([\s\S]*?)---/);
          let fm = {};
          let content = mdText;
          if(fmMatch){
            const fmText = fmMatch[1];
            fmText.split('\n').forEach(line=>{
              const [key,val] = line.split(':').map(s=>s.trim());
              if(key && val) fm[key]=val;
            });
            content = mdText.replace(fmMatch[0],'');
          }
          titleEl.textContent = fm.title || 'Untitled';
          mainImage.src = fm.image || '';
          authorImage.src = fm.author_image || '';
          authorName.textContent = fm.author || 'Unknown';
          bodyEl.innerHTML = marked.parse(content);
        });
      // update buttons
      prevBtn.style.display = (index>0)?'inline-block':'none';
      nextBtn.style.display = (index<articles.length-1)?'inline-block':'none';
    }

    prevBtn.addEventListener('click', ()=>{ loadArticle(currentIndex-1); });
    nextBtn.addEventListener('click', ()=>{ loadArticle(currentIndex+1); });

    // ========== Google Sign-In ==========
    googleSignInBtn.addEventListener('click', ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    });

    signOutBtn.addEventListener('click', ()=>{ auth.signOut(); });

    auth.onAuthStateChanged(user=>{
      if(user){
        googleSignInBtn.style.display='none';
        userInfo.style.display='inline';
        commentForm.style.display='block';
        userNameEl.textContent = user.displayName;
      }else{
        googleSignInBtn.style.display='inline-block';
        userInfo.style.display='none';
        commentForm.style.display='none';
      }
    });

    // ========== Comments ==========
    function loadComments(){
      commentsList.innerHTML='';
      const articleKey = articles[currentIndex].replace(/\W/g,'_');
      const ref = db.ref('comments/'+articleKey);
      ref.on('value', snapshot=>{
        const data = snapshot.val() || {};
        Object.keys(data).forEach(key=>{
          const c = data[key];
          const div = document.createElement('div');
          div.className='border p-2 rounded bg-gray-100 dark:bg-gray-800';
          div.innerHTML=`<strong>${c.user}</strong>: ${c.text}`;
          commentsList.appendChild(div);
        });
      });
    }

    submitComment.addEventListener('click', ()=>{
      const text = commentInput.value.trim();
      if(!text) return;
      const user = auth.currentUser;
      if(!user) return alert('Sign in first');
      const articleKey = articles[currentIndex].replace(/\W/g,'_');
      const ref = db.ref('comments/'+articleKey);
      const newRef = ref.push();
      newRef.set({user: user.displayName, text});
      commentInput.value='';
    });

    // Load initial article and comments
    loadArticle(currentIndex);
    loadComments();

  </script>
</body>
</html>
